<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Tool</title>
</head>
<body>
    <div>
        <h1>Balance Tool</h1>
        <div>
            <h2>Rules</h2>
            <div>
                <input type="radio" id="additive" name="rule-type" value="additive" checked>
                <label for="additive">Additive Damage</label>
                <input type="radio" id="threshold" name="rule-type" value="threshold">
                <label for="threshold">Point Threshold</label>
            </div>
            <div id="additive-options">
                <div>
                    <label for="advantage-bonus">Add to Advantage:</label>
                    <input type="number" id="advantage-bonus" value="0">
                </div>
                <div>
                    <label for="disadvantage-bonus">Add to Disadvantage:</label>
                    <input type="number" id="disadvantage-bonus" value="0">
                </div>
            </div>
            <div id="threshold-options" style="display: none;">
                <div>
                    <label for="none-range">None Range:</label>
                    <input type="number" id="none-range-min" placeholder="Min">
                </div>
                <div>
                    <label for="advantage-range">Advantage Range:</label>
                    <input type="number" id="advantage-range-min" placeholder="Min">
                </div>
                <div>
                    <label for="disadvantage-range">Disadvantage Range:</label>
                    <input type="number" id="disadvantage-range-min" placeholder="Min">
                </div>
            </div>
        </div>
        <div>
            <div>
                <h2>Character 1</h2>
                <div>
                    <label for="char1-health">Health:</label>
                    <input type="number" id="char1-health" min="1" value="10">
                </div>
                <div>
                    <label for="char1-dice-size">Dice Size:</label>
                    <select id="char1-dice-size">
                        <option value="2">d2</option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                    </select>
                </div>
                <div>
                    <label for="char1-dice-count">Number of Dice:</label>
                    <input type="number" id="char1-dice-count" min="1" value="1">
                </div>
                <div>
                    <label for="char1-advantage">Advantage:</label>
                    <select id="char1-advantage">
                        <option value="none">None</option>
                        <option value="advantage">Advantage</option>
                        <option value="disadvantage">Disadvantage</option>
                    </select>
                </div>
            </div>

            <div>
                <h2>Character 2</h2>
                <div>
                    <label for="char2-health">Health:</label>
                    <input type="number" id="char2-health" min="1" value="10">
                </div>
                <div>
                    <label for="char2-dice-size">Dice Size:</label>
                    <select id="char2-dice-size">
                        <option value="2">d2</option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                    </select>
                </div>
                <div>
                    <label for="char2-dice-count">Number of Dice:</label>
                    <input type="number" id="char2-dice-count" min="1" value="1">
                </div>
                <div>
                    <label for="char2-advantage">Advantage:</label>
                    <select id="char2-advantage">
                        <option value="none">None</option>
                        <option value="advantage">Advantage</option>
                        <option value="disadvantage">Disadvantage</option>
                    </select>
                </div>
            </div>
        </div>

        <div>
            <h2>Battle Options</h2>
            <div>
                <label for="turn-order">Turn Order:</label>
                <select id="turn-order">
                    <option value="simultaneous">Simultaneous</option>
                    <option value="random">Random</option>
                    <option value="char1-first">Always Character 1 First</option>
                </select>
            </div>
            <div>
                <label for="fights">Number of Fights:</label>
                <input type="number" id="fights" min="1" value="1">
            </div>
            <div>
                <button id="fight-button">Fight!</button>
            </div>
        </div>

        <div>
            <h2>Results</h2>
            <div>
                <h3>Win Percentages</h3>
                <div>
                    <label>Character 1 Wins:</label>
                    <span id="char1-win-percent">0%</span>
                </div>
                <div>
                    <label>Character 2 Wins:</label>
                    <span id="char2-win-percent">0%</span>
                </div>
                <div>
                    <label>Draws:</label>
                    <span id="draw-percent">0%</span>
                </div>
            </div>
            <div>
                <h3>Turn Statistics</h3>
                <div>
                    <label>Average Number of Turns:</label>
                    <span id="avg-turns">0</span>
                </div>
                <div>
                    <label>Turn Standard Deviation:</label>
                    <span id="turns-std-dev">0</span>
                </div>
            </div>
            <div>
                <h3>Damage Statistics</h3>
                <div>
                    <label>Character 1 Average Damage:</label>
                    <span id="char1-avg-damage">0</span>
                </div>
                <div>
                    <label>Character 1 Damage Standard Deviation:</label>
                    <span id="char1-damage-std-dev">0</span>
                </div>
                <div>
                    <label>Character 1 Average Damage Per Turn:</label>
                    <span id="char1-avg-damage-per-turn">0</span>
                </div>
                <div>
                    <label>Character 1 Damage Per Turn Standard Deviation:</label>
                    <span id="char1-damage-per-turn-std-dev">0</span>
                </div>
                <div>
                    <label>Character 2 Average Damage:</label>
                    <span id="char2-avg-damage">0</span>
                </div>
                <div>
                    <label>Character 2 Damage Standard Deviation:</label>
                    <span id="char2-damage-std-dev">0</span>
                </div>
                <div>
                    <label>Character 2 Average Damage Per Turn:</label>
                    <span id="char2-avg-damage-per-turn">0</span>
                </div>
                <div>
                    <label>Character 2 Damage Per Turn Standard Deviation:</label>
                    <span id="char2-damage-per-turn-std-dev">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const additiveRadio = document.getElementById('additive');
            const thresholdRadio = document.getElementById('threshold');
            const additiveOptions = document.getElementById('additive-options');
            const thresholdOptions = document.getElementById('threshold-options');
            const advantageBonus = document.getElementById('advantage-bonus');
            const disadvantageBonus = document.getElementById('disadvantage-bonus');
            const char1Health = document.getElementById('char1-health');
            const char1DiceSize = document.getElementById('char1-dice-size');
            const char1DiceCount = document.getElementById('char1-dice-count');
            const char1Advantage = document.getElementById('char1-advantage');
            const char2Health = document.getElementById('char2-health');
            const char2DiceSize = document.getElementById('char2-dice-size');
            const char2DiceCount = document.getElementById('char2-dice-count');
            const char2Advantage = document.getElementById('char2-advantage');
            const turnOrder = document.getElementById('turn-order');
            const fights = document.getElementById('fights');
            const fightButton = document.getElementById('fight-button');

            // Get all threshold range inputs
            const thresholdInputs = [
                document.getElementById('none-range-min'),
                document.getElementById('none-range-max'),
                document.getElementById('advantage-range-min'),
                document.getElementById('advantage-range-max'),
                document.getElementById('disadvantage-range-min'),
                document.getElementById('disadvantage-range-max')
            ];

            // Get all result elements
            const resultElements = {
                char1WinPercent: document.getElementById('char1-win-percent'),
                char2WinPercent: document.getElementById('char2-win-percent'),
                drawPercent: document.getElementById('draw-percent'),
                avgTurns: document.getElementById('avg-turns'),
                turnsStdDev: document.getElementById('turns-std-dev'),
                char1AvgDamage: document.getElementById('char1-avg-damage'),
                char1DamageStdDev: document.getElementById('char1-damage-std-dev'),
                char1AvgDamagePerTurn: document.getElementById('char1-avg-damage-per-turn'),
                char1DamagePerTurnStdDev: document.getElementById('char1-damage-per-turn-std-dev'),
                char2AvgDamage: document.getElementById('char2-avg-damage'),
                char2DamageStdDev: document.getElementById('char2-damage-std-dev'),
                char2AvgDamagePerTurn: document.getElementById('char2-avg-damage-per-turn'),
                char2DamagePerTurnStdDev: document.getElementById('char2-damage-per-turn-std-dev')
            };

            function toggleOptions() {
                additiveOptions.style.display = additiveRadio.checked ? 'block' : 'none';
                thresholdOptions.style.display = thresholdRadio.checked ? 'block' : 'none';
            }

            // Initial state
            toggleOptions();

            // Add change listeners
            additiveRadio.addEventListener('change', () => {
                toggleOptions();
            });

            thresholdRadio.addEventListener('change', () => {
                toggleOptions();
            });

            fightButton.addEventListener('click', () => {
                updateCalculations();
            });

            function updateCalculations() {
                console.log('Fight started!');

                setGameState();
                setStatsState();

                if (window.gameState.ruleType === 'threshold') {
                    const char1DiceSize = window.gameState.characters.char1.diceSize;
                    const char2DiceSize = window.gameState.characters.char2.diceSize;
                    const maxDiceSize = Math.max(char1DiceSize, char2DiceSize);
                    
                    const noneMin = window.gameState.thresholdRules.noneRange.min;
                    const advantageMin = window.gameState.thresholdRules.advantageRange.min;
                    const disadvantageMin = window.gameState.thresholdRules.disadvantageRange.min;

                    if (noneMin > maxDiceSize || advantageMin > maxDiceSize || disadvantageMin > maxDiceSize) {
                        alert(`your min threshold is greater than your dice size, doofus`);
                        return;
                    }
                }
                
                const numberOfFights = window.gameState.numberOfFights;
                for (let i = 0; i < numberOfFights; i++) {
                    initializeFight();
                    battle();
                }
                
                updateResults();
            }

            function setGameState() {
                // Set rule type
                window.gameState = {
                    ruleType: additiveRadio.checked ? 'additive' : 'threshold',
                    turnOrder: turnOrder.value,
                    numberOfFights: parseInt(fights.value),
                    characters: {
                        char1: {
                            health: parseInt(char1Health.value),
                            maxHealth: parseInt(char1Health.value),
                            diceSize: parseInt(char1DiceSize.value),
                            diceCount: parseInt(char1DiceCount.value),
                            advantage: char1Advantage.value
                        },
                        char2: {
                            health: parseInt(char2Health.value),
                            maxHealth: parseInt(char2Health.value),
                            diceSize: parseInt(char2DiceSize.value),
                            diceCount: parseInt(char2DiceCount.value),
                            advantage: char2Advantage.value
                        }
                    }
                };

                // Add rule-specific settings
                if (gameState.ruleType === 'additive') {
                    gameState.additiveRules = {
                        advantageBonus: parseInt(advantageBonus.value),
                        disadvantageBonus: parseInt(disadvantageBonus.value)
                    };
                } else {
                    gameState.thresholdRules = {
                        noneRange: {
                            min: parseInt(document.getElementById('none-range-min').value)
                        },
                        advantageRange: {
                            min: parseInt(document.getElementById('advantage-range-min').value)
                        },
                        disadvantageRange: {
                            min: parseInt(document.getElementById('disadvantage-range-min').value)
                        }
                    };
                }
            }

            function setStatsState() {
                window.statsState = {
                    char1Wins: 0,
                    char2Wins: 0,
                    draws: 0,
                    turns: [],
                    char1Damage: [],
                    char2Damage: [],
                    char1DamagePerTurn: [],
                    char2DamagePerTurn: []
                }
            }

            function initializeFight() {
              window.fightStats = {
                char1Health: window.gameState.characters.char1.health,
                char2Health: window.gameState.characters.char2.health,
              }
            }

            function calculateAverage(numbers) {
                return numbers.reduce((sum, num) => sum + num, 0) / numbers.length;
            }

            function calculateStandardDeviation(numbers) {
                const avg = calculateAverage(numbers);
                const variance = numbers.reduce((sum, num) => sum + Math.pow(num - avg, 2), 0) / numbers.length;
                return Math.sqrt(variance);
            }

            function formatPercentage(value, total) {
                return `${((value / total) * 100).toFixed(1)}%`;
            }

            function formatNumber(value) {
                return value.toFixed(1);
            }

            function updateResults() {
                const { numberOfFights } = window.gameState;
                const { char1Wins, char2Wins, draws, turns, char1Damage, char2Damage, char1DamagePerTurn, char2DamagePerTurn } = window.statsState;

                // Update win percentages
                resultElements.char1WinPercent.textContent = formatPercentage(char1Wins, numberOfFights);
                resultElements.char2WinPercent.textContent = formatPercentage(char2Wins, numberOfFights);
                resultElements.drawPercent.textContent = formatPercentage(draws, numberOfFights);

                // Update turn statistics
                const avgTurns = calculateAverage(turns);
                const turnsStdDev = calculateStandardDeviation(turns);
                resultElements.avgTurns.textContent = formatNumber(avgTurns);
                resultElements.turnsStdDev.textContent = formatNumber(turnsStdDev);

                // Update Character 1 damage statistics
                const char1AvgDamage = calculateAverage(char1Damage);
                const char1DamageStdDev = calculateStandardDeviation(char1Damage);
                const char1AvgDamagePerTurn = calculateAverage(char1DamagePerTurn);
                const char1DamagePerTurnStdDev = calculateStandardDeviation(char1DamagePerTurn);
                resultElements.char1AvgDamage.textContent = formatNumber(char1AvgDamage);
                resultElements.char1DamageStdDev.textContent = formatNumber(char1DamageStdDev);
                resultElements.char1AvgDamagePerTurn.textContent = formatNumber(char1AvgDamagePerTurn);
                resultElements.char1DamagePerTurnStdDev.textContent = formatNumber(char1DamagePerTurnStdDev);

                // Update Character 2 damage statistics
                const char2AvgDamage = calculateAverage(char2Damage);
                const char2DamageStdDev = calculateStandardDeviation(char2Damage);
                const char2AvgDamagePerTurn = calculateAverage(char2DamagePerTurn);
                const char2DamagePerTurnStdDev = calculateStandardDeviation(char2DamagePerTurn);
                resultElements.char2AvgDamage.textContent = formatNumber(char2AvgDamage);
                resultElements.char2DamageStdDev.textContent = formatNumber(char2DamageStdDev);
                resultElements.char2AvgDamagePerTurn.textContent = formatNumber(char2AvgDamagePerTurn);
                resultElements.char2DamagePerTurnStdDev.textContent = formatNumber(char2DamagePerTurnStdDev);
            }

            function battle() {
                let turn = 0;
                let char1TotalDamage = 0;
                let char2TotalDamage = 0;
                let char1DamageThisTurn = 0;
                let char2DamageThisTurn = 0;
                do {
                    turn++;
                    const char1Damage = getDamage(window.gameState.characters.char1);
                    const char2Damage = getDamage(window.gameState.characters.char2);

                    let isChar1Turn = window.gameState.turnOrder === 'char1-first' || (window.gameState.turnOrder === 'random' && Math.random() < 0.5);
                    
                    if (window.gameState.turnOrder === 'simultaneous') {
                        char1TotalDamage += char1Damage;
                        char2TotalDamage += char2Damage;
                        char1DamageThisTurn += char1Damage;
                        char2DamageThisTurn += char2Damage;
                        window.fightStats.char2Health -= char1Damage;
                        window.fightStats.char1Health -= char2Damage;
                    } else if (isChar1Turn) {
                        char1TotalDamage += char1Damage;
                        char1DamageThisTurn += char1Damage;
                        window.fightStats.char2Health -= char1Damage;
                        if (window.fightStats.char2Health <= 0) {
                            break;
                        }
                        char2TotalDamage += char2Damage;
                        char2DamageThisTurn += char2Damage;
                        window.fightStats.char1Health -= char2Damage;
                    } else {
                        char2TotalDamage += char2Damage;
                        char2DamageThisTurn += char2Damage;
                        window.fightStats.char1Health -= char2Damage;
                        if (window.fightStats.char1Health <= 0) {
                            break;
                        }
                        char1TotalDamage += char1Damage;
                        char1DamageThisTurn += char1Damage;
                        window.fightStats.char2Health -= char1Damage;
                    }

                    window.statsState.char1DamagePerTurn.push(char1DamageThisTurn);
                    window.statsState.char2DamagePerTurn.push(char2DamageThisTurn);
                    char1DamageThisTurn = 0;
                    char2DamageThisTurn = 0;

                } while (window.fightStats.char1Health > 0 && window.fightStats.char2Health > 0);

                window.statsState.turns.push(turn);
                window.statsState.char1Damage.push(char1TotalDamage);
                window.statsState.char2Damage.push(char2TotalDamage);

                if (window.fightStats.char1Health <= 0 && window.fightStats.char2Health > 0) {
                    window.statsState.char2Wins++;
                } else if (window.fightStats.char2Health <= 0 && window.fightStats.char1Health > 0) {
                    window.statsState.char1Wins++;
                } else {
                    window.statsState.draws++;
                }
            }


            function rollDice(diceSize, diceCount) {
                const rolls = [];
                for (let i = 0; i < diceCount; i++) {
                    rolls.push(Math.floor(Math.random() * diceSize) + 1);
                }
                return rolls;
            }

            function getDamage(character) {
              const rolls = rollDice(character.diceSize, character.diceCount);
              if (window.gameState.ruleType === 'additive') {
                return additiveDamage(rolls, character);
              } else {
                return thresholdDamage(rolls, character);
              }
            }

            function additiveDamage(rolls, character) {
                let damageMod = 0;
                if (character.advantage === 'advantage') {
                    damageMod = window.gameState.additiveRules.advantageBonus;
                } else if (character.advantage === 'disadvantage') {
                    damageMod = window.gameState.additiveRules.disadvantageBonus;
                }
                return rolls.reduce((sum, roll) => sum + roll, 0) + damageMod;
            }

            function thresholdDamage(rolls, character) {
                let range = {};
                if (character.advantage === 'advantage') {
                    range = window.gameState.thresholdRules.advantageRange;
                } else if (character.advantage === 'disadvantage') {
                    range = window.gameState.thresholdRules.disadvantageRange;
                } else {
                    range = window.gameState.thresholdRules.noneRange;
                }
                let damage = 0;
                for (let i = 0; i < rolls.length; i++) {
                    if (rolls[i] >= range.min && rolls[i] <= character.diceSize) {
                        damage += 1;
                    }
                }
                return damage;
            }
        });
    </script>
</body>
</html>
